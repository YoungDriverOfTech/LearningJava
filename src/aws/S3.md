# S3
## Amazon S3 Use cases
- 备份和存储(Backup and storage)
- 灾难恢复(Disaster Recovery)
- 归档(Archive)
- 混合云存储(Hybrid Cloud storage)
- 应用程序托管(Application hosting)
- ...

## Buckets 桶
- s3允许人存储文件到桶里（路径）
- 桶的名字必须唯一，跨所有区，所有账户，都唯一
- 桶在region的层级被定义
- s3看起来像是全球服务，但是是在region区域内被创建的
- 命名
  - 没大写，没下划线
  - 3-36字符长度
  - 不能是ip
  - 开头必须小写或者数字
  - 开头不能是xn--
  - 结尾不能是-s3alias

## Object 文件对象
- Object有一个key
- key是一个全路径
  - s3://my-bucket/my_folder1/another_folder/my_file.txt
- key由**前缀**+***object***名字组成
  - s3://my-bucket/**my_folder1/another_folder**/***my_file.txt***
- s3里面没有文件夹的概念，只是ui展示的时候会展示成文件夹

## Object size
- 最大文件的size是5TB
- 如果文件上传的时候超过5GB，使用分段上传 multi-part upload
- Metadata，元数据（键值对集合）
- Tags 类似于lable
- Version ID，如果启用了version的功能

## Hands on
![img.png](img.png)
![img_1.png](img_1.png)
![img_2.png](img_2.png)
![img_3.png](img_3.png)
![img_4.png](img_4.png)


## Security
- 基于用户 user based
  - IAM policies 应允许特定用户从 IAM 调用哪些 API
- 基于资源 resource based
  - Bucket policies 来自 S3 控制台的存储桶范围规则 - 允许跨帐户
  - Object Access Control List(ACL) 可以被禁用
  - Bucket Access Control List(ACL) 可以被禁用
- Note: 一个IAM委托人可以访问s3文件，如果
  - 用户IAM权限允许或者资源允许
  - 并且没有明确的拒绝
- 加密
  - s3使用加密key来加密文件

## Bucket Policies
- JSON based policies
  - Resources：桶和文件（object）
  - Effect：Allow/Deny
  - Actions：允许或者拒绝API的访问
  - Principal：收policy影响账户或者用户
- 使用s3的bucket policy可以
  - 开放bucket共public使用
  - 强制object必须被加密，在上传的时候
  - 开放另一个账户的访问bucket权限

### Public Access - Use Bucket Policy
![img_5.png](img_5.png)

### User Access to S3 - IAM permissions
![img_6.png](img_6.png)

### EC2 Access to S3 - Role
![img_7.png](img_7.png)

### Cross-Account Access - Use Bucket Policy
![img_8.png](img_8.png)

### Bucket settings Block Public Access 
![img_9.png](img_9.png)
- 这些设定是用来防止公司数据泄漏
- 如果知道数据绝不是公开的，那么就开启这些设定
- 可以在账户级别设置

### 开放bucket给public
![img_10.png](img_10.png)
![img_11.png](img_11.png)
![img_12.png](img_12.png)
![img_13.png](img_13.png)
![img_14.png](img_14.png)

## S3挂载静态网页
![img_15.png](img_15.png)
![img_16.png](img_16.png)
![img_17.png](img_17.png)
![img_18.png](img_18.png)
![img_19.png](img_19.png)

## S3 Versioning 版本控制
- 可以在s3中控制文件版本
- 在bucket level启用
- 相同的key发生覆盖，就会改变版本
- 好处
  - 防止误操作
  - 容易回滚
- 注意
  - 任何文件在开启版本控制之前，有一个null的版本
  - 暂停版本控制不会删除以前的版本
![img_20.png](img_20.png)

### hands on
![img_21.png](img_21.png)
![img_22.png](img_22.png)
![img_23.png](img_23.png)
![img_24.png](img_24.png)

## S3 Replication 副本（CRR & SRR）
### 概念
- 必须在source / dest bucket中启动版本控制
- Cross-Region Replication（CRR）跨region同步文件
- Same-Region Replication（SRR）同region同步文件
- 桶可以在不同的账户
- 复制是异步进行的
- 必须给适当的IAM权限到S3
- 使用case
  - CRR：合规性、低延迟访问、跨域复制
  - SRR：日志聚合，生产和测试之间的实时复制

### Notes
- 在启用replication后，只有新的object会被做副本
- 可以使用S3 batch replication在同步之前存在的文件
- 对于删除操作
  - 可以复制删除marks（可选设定），即不开启Show versions，直接删除，s3会生成一个delete marker来标记某个object会被删除，这个delete marker会被复制到dest桶
  - 不能复制删除带有版本id的文件（避免恶意删除），开启Show versions在删除以后，不会进行删除操作的复制
- 没有链式复制
  - a和b同步，b和c同步。但是a和c不同步

### hands on
![img_25.png](img_25.png)
![img_26.png](img_26.png)
![img_27.png](img_27.png)
![img_28.png](img_28.png)


## S3 Storage Classes 存储类别
### 分类
- Amazon S3 Standard - General Purpose
- Amazon S3 Standard-Infrequent Access (IA)
- Amazon S3 One Zone-Infrequent Access
- Amazon S3 Glacier Instant Retrieval
- Amazon S3 Glacier Flexible Retrieval
- Amazon S3 Glacier Deep Archive
- Amazon S3 Intelligent Tiering
- Can move between classes manually or using S3 Lifecycle configurations

### 持久性和可用性
- Durability
  - 文件跨可用区，高持久性
  - 如果存储了10000000个文件在s3，文件损失的平均频率是10000年一个
  - 所有的存储类别都是高持久
- Availability
  - 根据存储类别的不同来变化
  - 比如：standard 有99.99%可用性 = 一年只有53分钟不可用

### 对比
![img_29.png](img_29.png)
![img_30.png](img_30.png)


### hands on

![img_31.png](img_31.png)
![img_32.png](img_32.png)
![img_33.png](img_33.png)
![img_34.png](img_34.png)
![img_35.png](img_35.png)
![img_36.png](img_36.png)


## Moving between Storage Calsses
- 可以把文件在不同的存储类中转移
- 对于不常访问的，可以放到Standard IA
- 对于不需要快速访问的，可以归档到Glacier或者Glacier Deep Archive
- 可以使用Lifecycle Rules来移动文件
![img_37.png](img_37.png)

### Lifecycle Rules
- 转移行为：配置文件转移到另一存储类中
  - 移动文件到Standard IA在创建后的60天
  - 移动到Glacier 进行归档在6个月之后
- Expiration actions：配置文件过期（删除）在一定时间之后
  - 访问日志文件可以被删除在365天之后
  - 可以删除旧版本的文件如果启动了版本控制的话
  - 可以删除不完成的Multi-Part文件
- 可以位特定的前缀创建规则（比如：s3://mybucket/mp3/*）
- 可以位特定Tag创建规则（比如：Department: Finance）

### hands on
![img_38.png](img_38.png)
![img_39.png](img_39.png)

## 请求着支付
- 总的来说，bucket的拥有者会支付s3存储和数据转移的所有费用
- 但是在请求者支付的模式下，请求者会支付请求s3和下载文件的文勇
- 当分享大文件的时候，可以使用
- 请求者必须是被aws认证过的
![img_40.png](img_40.png)

## S3 Event Notifications 事件通知
### 理论
- 事件是啥：S3:ObjectCreated, S3:ObjectRemoved, S3:ObjectRestore, S3:Replication…
- 可以过滤对象的名字（可以*.jpg）
- 可以创建很多s3的事件
- s3推送消息需要花费几秒钟，长的话可能几分钟
![img_41.png](img_41.png)

### s3向外部推送消息
需要接受消息的一样设置权限，能够接受s3推送过来的消息
![img_42.png](img_42.png)

### EventBridge 监听s3的所有事件
- 更高级的过滤器：可以使用JSON规则（metadata，object size，name）
- 多个推送目的地
![img_43.png](img_43.png)

### Practice 推送消息到SQS队列
![img_44.png](img_44.png)
![img_45.png](img_45.png)
![img_46.png](img_46.png)
![img_47.png](img_47.png)
![img_48.png](img_48.png)
![img_49.png](img_49.png)
![img_50.png](img_50.png)
![img_51.png](img_51.png)
![img_52.png](img_52.png)
![img_53.png](img_53.png)
![img_54.png](img_54.png)

## S3 Performance
### 基础表现
- App可以对s3进行3500 put/copy/post/delete 或者5500 get/head的请求每秒钟。针对每个前缀在同一个桶内
- 并且在桶内没有对文件数量的限制就可以达到上面的效果
- 什么是前缀（object path => prefix）
  - bucket/folder1/sub1/file  => /folder1/sub1/
  - bucket/folder1/sub2/file  => /folder1/sub2/

### 其他performance
- Multi-Part upload
  - 推荐使用，当文件大于100MB。当文件大于5GB，必须使用
  - 可以并发upload
![img_55.png](img_55.png)
- S3 Transfer加速
  - 通过上传文件到一个边缘的Location，这个location会传输文件到想到的地方
  - Multi-part upload也使用
![img_56.png](img_56.png)

### S3 Byte-Range Fetches 子节范围内拉去
- 并发的获取特定的子节范围
- 发生故障时候，更好恢复
![img_57.png](img_57.png)
- 也可以只获取部分数据（比如文件的前多少子节是文件头，只获取文件头之类）
![img_58.png](img_58.png)

## S3 Select & Glacier Select
- 使用SQL进行服务器端的过滤，拉取更晓得数据来提高性能
- 可以过滤行/列（简单的SQL）
- 更少的网络传输，客户端更少的CPU消耗
![img_59.png](img_59.png)

## S3 Batch Operations 批量操作
- 对s3的文件进行批量操作，只用一次请求。比如
  - 修改metadata&properties
  - 在桶之间复制文件
  - 加密数据
  - 修改ACLs和tags
  - 从Glacier中复原文件
  - 执行Lambda函数
- 一个job由3部分组成
  - object的list
  - 要执行的动作
  - 可选择的参数
- 可以使用s3仓库获取object list然后使用S3 select区过滤文件
![img_60.png](img_60.png)

## Object Encryption
- 可以在s3的桶中，使用下面4中加密方法
  - Server-Side Encryption(SSE) 服务器端加密
    - 使用AWS S3管理的key加密：Amazon S3-Managed Keys(SSE-S3) 默认开启
    - KMS keys加密啊，存储在AWS KMS(SSE-KMS)
    - 使用用户提供的key加密, Customer-Provided Keys(SSE-C)
  - 客户端加密后上传到s3

### SSE-S3
- 加密用的key，由aws来管理和保存以及处理
- object在服务器端加密
- 加密类型是AWS-256
- 必须设置请求头: "x-amz-server-side-encryption" : "AWS256"
- 默认给新的桶和新的object开启
![img_61.png](img_61.png)

### SSE-KMS
- 加密使用的key，由AWS KMS（Key Management Service）保管
- KMS优势：用户控制+CloudTrail审查key
- object在服务器端加密
- 必须设置请求头： "x-amz-server-side-encryption" : "aws:kms"
![img_62.png](img_62.png)

- KMS缺点
  - 如果使用SSE-KMS，必须接受KMS的缺点
  - 当上传的时候，会调用GenerateDataKey KMS API
  - 下载的时候会调用Decrypt KMS API
  - 计入每秒 KMS 配额 （5500、10000、30000 请求/秒，具体取决于区域）
  - 您可以使用以下方式请求增加配额： 服务配额控制台
![img_63.png](img_63.png)

### SSE-C
- 服务端加密的key由用户提供
- S3不会存储用户提供的key
- 必须使用HTTPS
- 加密的key必须在HTTP请求头中设置
![img_64.png](img_64.png)

### Client-Side Encryption
- 使用客户端类库类进行加密，比如：Amazon S3 Client-Side Encryption Library
- 加密必须在发送给s3之前完成
- 解密在object从s3上下载后进行
- 用户控制key
![img_65.png](img_65.png)

### 传输加密 Encryption in transit(SSL/TLS)
- 传输加密也叫做 SSL/TLS
- s3会开放两个endpoints
  - HTTP endpoint：非加密的
  - HTTPS endpoint：加密的
- HTTPS是推荐的
- SSE-C强制使用HTTPS
- 多数客户端默认使用HTTPS endpoints

### 传输强制加密
- aws:Secure Transport

![img_66.png](img_66.png)

### hands on
![img_67.png](img_67.png)
![img_68.png](img_68.png)

## Default encryption vs Bucket Policies
- SSE-S3加密会被自用运用到s3桶中的objects上
- 相对的，也可以使用bucket policy来相知加密，这样就可以在put object到s3的时候不用设置加密的header了
- Bucket policy优先级高于默认加密
![img_69.png](img_69.png)


## CORS
### 概念
- Cross-Origin Resource Sharing(CORS)
- Origin = scheme(protocol) + host(domain) + port
  - example: https://www.example.com (443是https默认端口，80是http的)
- 基于浏览器的机制，允许在访问主源的同时访问其他的源
  - 同源：http://example.com/app1 & http://example.com/app2
  - 不同源：http://www.example.com & http://other.example.com
- 如果不设置Cors（Access-Control-Allow-Origin）请求头，那么请求就不会成立

### 图解
![img_70.png](img_70.png)

### S3-CORS
- 如果客户端发送了一个跨域请求到s3，我们需要启用正确的cors请求头
- 考试常考
- 可以允许所有的或者特定的源来访问s3
![img_71.png](img_71.png)

### Hands on
![img_72.png](img_72.png)

## MFA Delete
###
- MFA(Multi-Facto Authentication) 强制用户在删除s3某一个指定版本的object的时候，输入一个动态code
- 下面会要求用MFA
  - 持久的删除一个object版本
  - 暂停桶的版本控制
- 下面不要求MFA
  - 启用版本控制
  - 列出被删除的版本
- 要使用MFA Delete，必须启动版本控制
- 只用root account能够启用和关闭MFA

### Hands on
![img_73.png](img_73.png) 

## S3 Access Logs
### 概念
- 可以把对某一个桶的操作log放到另一个桶里面
- 存放log的桶必须和产生log的桶在同一个region里面
- 存放别的桶的日志的桶不能用来存放本身日志，因为会产生一个日志的循环
![img_74.png](img_74.png)

### Hands on
![img_75.png](img_75.png)

## Pre-Signed URLS 事前签名URL
### 概念
- 在一个不公开的桶中，所有的object的都是不公开的，但现在向临时创造一个url可以把object公开给用户，但是这个url是有时间限制的。这个就是pre-signed url
- 可以用s3 console，cli或者sdk来生成
- 过期时间
  - s3 console：1-720min
  - cli：默认3600 sec，最大6048000 sec(169 hours)
- 被给予预签名URL的用户，继承了生成预签名URL用户的get，put权限
- 例子
  - 允许login的用户下载video
  - 通过动态生成 URL 允许不断变化的用户列表下载文件
  - 临时允许一个用户上传文件到s3指定的文职

### hands on
![img_76.png](img_76.png)

