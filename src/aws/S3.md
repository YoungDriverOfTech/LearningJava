# S3
## Amazon S3 Use cases
- 备份和存储(Backup and storage)
- 灾难恢复(Disaster Recovery)
- 归档(Archive)
- 混合云存储(Hybrid Cloud storage)
- 应用程序托管(Application hosting)
- ...

## Buckets 桶
- s3允许人存储文件到桶里（路径）
- 桶的名字必须唯一，跨所有区，所有账户，都唯一
- 桶在region的层级被定义
- s3看起来像是全球服务，但是是在region区域内被创建的
- 命名
  - 没大写，没下划线
  - 3-36字符长度
  - 不能是ip
  - 开头必须小写或者数字
  - 开头不能是xn--
  - 结尾不能是-s3alias

## Object 文件对象
- Object有一个key
- key是一个全路径
  - s3://my-bucket/my_folder1/another_folder/my_file.txt
- key由**前缀**+***object***名字组成
  - s3://my-bucket/**my_folder1/another_folder**/***my_file.txt***
- s3里面没有文件夹的概念，只是ui展示的时候会展示成文件夹

## Object size
- 最大文件的size是5TB
- 如果文件上传的时候超过5GB，使用分段上传 multi-part upload
- Metadata，元数据（键值对集合）
- Tags 类似于lable
- Version ID，如果启用了version的功能

## Hands on
![img.png](img.png)
![img_1.png](img_1.png)
![img_2.png](img_2.png)
![img_3.png](img_3.png)
![img_4.png](img_4.png)


## Security
- 基于用户 user based
  - IAM policies 应允许特定用户从 IAM 调用哪些 API
- 基于资源 resource based
  - Bucket policies 来自 S3 控制台的存储桶范围规则 - 允许跨帐户
  - Object Access Control List(ACL) 可以被禁用
  - Bucket Access Control List(ACL) 可以被禁用
- Note: 一个IAM委托人可以访问s3文件，如果
  - 用户IAM权限允许或者资源允许
  - 并且没有明确的拒绝
- 加密
  - s3使用加密key来加密文件

## Bucket Policies
- JSON based policies
  - Resources：桶和文件（object）
  - Effect：Allow/Deny
  - Actions：允许或者拒绝API的访问
  - Principal：收policy影响账户或者用户
- 使用s3的bucket policy可以
  - 开放bucket共public使用
  - 强制object必须被加密，在上传的时候
  - 开放另一个账户的访问bucket权限

### Public Access - Use Bucket Policy
![img_5.png](img_5.png)

### User Access to S3 - IAM permissions
![img_6.png](img_6.png)

### EC2 Access to S3 - Role
![img_7.png](img_7.png)

### Cross-Account Access - Use Bucket Policy
![img_8.png](img_8.png)

### Bucket settings Block Public Access 
![img_9.png](img_9.png)
- 这些设定是用来防止公司数据泄漏
- 如果知道数据绝不是公开的，那么就开启这些设定
- 可以在账户级别设置

### 开放bucket给public
![img_10.png](img_10.png)
![img_11.png](img_11.png)
![img_12.png](img_12.png)
![img_13.png](img_13.png)
![img_14.png](img_14.png)

## S3挂载静态网页
![img_15.png](img_15.png)
![img_16.png](img_16.png)
![img_17.png](img_17.png)
![img_18.png](img_18.png)
![img_19.png](img_19.png)

## S3 Versioning 版本控制
- 可以在s3中控制文件版本
- 在bucket level启用
- 相同的key发生覆盖，就会改变版本
- 好处
  - 防止误操作
  - 容易回滚
- 注意
  - 任何文件在开启版本控制之前，有一个null的版本
  - 暂停版本控制不会删除以前的版本
![img_20.png](img_20.png)

### hands on
![img_21.png](img_21.png)
![img_22.png](img_22.png)
![img_23.png](img_23.png)
![img_24.png](img_24.png)

## S3 Replication 副本（CRR & SRR）
### 概念
- 必须在source / dest bucket中启动版本控制
- Cross-Region Replication（CRR）跨region同步文件
- Same-Region Replication（SRR）同region同步文件
- 桶可以在不同的账户
- 复制是异步进行的
- 必须给适当的IAM权限到S3
- 使用case
  - CRR：合规性、低延迟访问、跨域复制
  - SRR：日志聚合，生产和测试之间的实时复制

### Notes
- 在启用replication后，只有新的object会被做副本
- 可以使用S3 batch replication在同步之前存在的文件
- 对于删除操作
  - 可以复制删除marks（可选设定），即不开启Show versions，直接删除，s3会生成一个delete marker来标记某个object会被删除，这个delete marker会被复制到dest桶
  - 不能复制删除带有版本id的文件（避免恶意删除），开启Show versions在删除以后，不会进行删除操作的复制
- 没有链式复制
  - a和b同步，b和c同步。但是a和c不同步

### hands on
![img_25.png](img_25.png)
![img_26.png](img_26.png)
![img_27.png](img_27.png)
![img_28.png](img_28.png)


## S3 Storage Classes 存储类别
### 分类
- Amazon S3 Standard - General Purpose
- Amazon S3 Standard-Infrequent Access (IA)
- Amazon S3 One Zone-Infrequent Access
- Amazon S3 Glacier Instant Retrieval
- Amazon S3 Glacier Flexible Retrieval
- Amazon S3 Glacier Deep Archive
- Amazon S3 Intelligent Tiering
- Can move between classes manually or using S3 Lifecycle configurations

### 持久性和可用性
- Durability
  - 文件跨可用区，高持久性
  - 如果存储了10000000个文件在s3，文件损失的平均频率是10000年一个
  - 所有的存储类别都是高持久
- Availability
  - 根据存储类别的不同来变化
  - 比如：standard 有99.99%可用性 = 一年只有53分钟不可用

### 对比
![img_29.png](img_29.png)
![img_30.png](img_30.png)


### hands on

![img_31.png](img_31.png)
![img_32.png](img_32.png)
![img_33.png](img_33.png)
![img_34.png](img_34.png)
![img_35.png](img_35.png)
![img_36.png](img_36.png)


## Moving between Storage Calsses
- 可以把文件在不同的存储类中转移
- 对于不常访问的，可以放到Standard IA
- 对于不需要快速访问的，可以归档到Glacier或者Glacier Deep Archive
- 可以使用Lifecycle Rules来移动文件
![img_37.png](img_37.png)

### Lifecycle Rules
- 转移行为：配置文件转移到另一存储类中
  - 移动文件到Standard IA在创建后的60天
  - 移动到Glacier 进行归档在6个月之后
- Expiration actions：配置文件过期（删除）在一定时间之后
  - 访问日志文件可以被删除在365天之后
  - 可以删除旧版本的文件如果启动了版本控制的话
  - 可以删除不完成的Multi-Part文件
- 可以位特定的前缀创建规则（比如：s3://mybucket/mp3/*）
- 可以位特定Tag创建规则（比如：Department: Finance）

### hands on
![img_38.png](img_38.png)
![img_39.png](img_39.png)




